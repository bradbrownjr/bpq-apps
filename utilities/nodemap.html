<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packet Radio Network Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            line-height: 1.6;
        }
        .legend-item { display: flex; align-items: center; margin: 3px 0; }
        .legend-color { width: 20px; height: 3px; margin-right: 8px; }
        .popup-content h3 { margin: 0 0 8px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .popup-content p { margin: 4px 0; font-size: 13px; }
        .popup-content .label { font-weight: bold; color: #666; }
        .popup-content .apps { color: #2196F3; }
        .popup-content .freqs { color: #FF9800; }
        .info-box {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Node data
        var nodes = [{"callsign": "K1NYY", "lat": 44.10416666666667, "lon": -69.375, "grid": "FN54HC", "city": "Waldoboro", "state": "ME", "type": "BPQ", "sponsor": null, "netrom_access": ["LLNWDB:K1NYY-15}"], "applications": ["RMS", "BBS"], "frequencies": [{"text": "433.3 MHz (70cm)", "color": "#FF9800"}, {"text": "144.99 MHz (2m)", "color": "#2196F3"}], "ssids": [], "neighbors": ["AB1KI", "KX1RMA", "KX1EMA", "KS1R", "N1REX", "KC1JEH", "W1DTX", "KC1JMH", "AB1KK", "W1ZE", "N1QFY", "KX1NMA", "W1EMA", "AB1KN", "KM1JMH", "KX1KMA", "AB1CI", "N1LJK", "KY2D"]}, {"callsign": "WS1EC", "lat": 43.72916666666667, "lon": -70.45833333333333, "grid": "FN43SR", "city": "Cumberland County", "state": "EM", "type": "BPQ", "sponsor": null, "netrom_access": ["CCEMA:WS1EC-15}"], "applications": ["BBS", "CHAT", "FORTUNE", "RMS", "WX", "SYSINFO", "CALLOUT", "SPACE", "BANDS", "QRZ", "GOPHER", "NEWS", "TEST", "FORMS"], "frequencies": [{"text": "433.3 MHz (70cm)", "color": "#FF9800"}, {"text": "145.05 MHz (2m)", "color": "#2196F3"}], "ssids": [], "neighbors": ["KC1JMH"]}, {"callsign": "N1REX", "lat": 44.22916666666667, "lon": -69.625, "grid": "FN54EF", "city": "Node", "state": "LN", "type": "BPQ", "sponsor": null, "netrom_access": ["LNCWHT:N1REX-15}"], "applications": ["RMS", "BBS", "CHAT"], "frequencies": [{"text": "433.1 MHz (70cm)", "color": "#FF9800"}, {"text": "145.09 MHz (2m)", "color": "#2196F3"}], "ssids": [], "neighbors": ["KC1JMH", "AB1KI", "K1NYY", "N1QFY"]}, {"callsign": "KC1JMH", "lat": 43.6875, "lon": -70.375, "grid": "FN43TQ", "city": "Westbrook", "state": "ME", "type": "BPQ", "sponsor": null, "netrom_access": ["CMBWBK:KC1JMH-15}"], "applications": ["BBS", "RMS", "CHAT"], "frequencies": [{"text": "433.3 MHz (70cm)", "color": "#FF9800"}, {"text": "144.93 MHz (2m)", "color": "#2196F3"}], "ssids": [], "neighbors": ["K1NYY", "WS1EC", "N1REX", "N1QFY", "KS1R"]}, {"callsign": "KS1R", "lat": 43.8125, "lon": -69.79166666666666, "grid": "FN53CT", "city": "Node", "state": "BU", "type": "BPQ", "sponsor": null, "netrom_access": ["BURG:KS1R-15}"], "applications": ["BBS", "CHAT"], "frequencies": [{"text": "145.01 MHz (2m)", "color": "#2196F3"}, {"text": "433.3 MHz (70cm)", "color": "#FF9800"}, {"text": "223.6 MHz (1.25m)", "color": "#9C27B0"}], "ssids": [], "neighbors": ["WD1F", "AB1KI", "KX1RMA", "KC1JMF", "KX1EMA", "N1LJK", "N1REX", "WD1O", "W1DTX", "W1ZE", "KC1JMH", "KC1JEH", "N1QFY", "W1LH", "K1NYY", "KX1KMA", "KX1nMA"]}, {"callsign": "N1QFY", "lat": 44.22916666666667, "lon": -69.79166666666666, "grid": "FN54CF", "city": "Gardiner", "state": "ME", "type": "BPQ", "sponsor": null, "netrom_access": ["KNNGNR:N1QFY-15}"], "applications": ["RMS", "BBS", "CHAT"], "frequencies": [{"text": "433.3 MHz (70cm)", "color": "#FF9800"}, {"text": "145.07 MHz (2m)", "color": "#2196F3"}], "ssids": [], "neighbors": ["AB1KI", "KS1R", "KX1EMA", "N1REX", "WD1O", "KC1JMH", "W1EMA", "NG1P", "K1NYY", "KM1JMH", "KB1TAE"]}];
        var connections = [{"from": "K1NYY", "to": "KS1R", "from_lat": 44.10416666666667, "from_lon": -69.375, "to_lat": 43.8125, "to_lon": -69.79166666666666, "color": "#FF9800", "frequency": 433.3}, {"from": "K1NYY", "to": "N1REX", "from_lat": 44.10416666666667, "from_lon": -69.375, "to_lat": 44.22916666666667, "to_lon": -69.625, "color": "#FF9800", "frequency": 433.3}, {"from": "K1NYY", "to": "KC1JMH", "from_lat": 44.10416666666667, "from_lon": -69.375, "to_lat": 43.6875, "to_lon": -70.375, "color": "#FF9800", "frequency": 433.3}, {"from": "K1NYY", "to": "N1QFY", "from_lat": 44.10416666666667, "from_lon": -69.375, "to_lat": 44.22916666666667, "to_lon": -69.79166666666666, "color": "#FF9800", "frequency": 433.3}, {"from": "WS1EC", "to": "KC1JMH", "from_lat": 43.72916666666667, "from_lon": -70.45833333333333, "to_lat": 43.6875, "to_lon": -70.375, "color": "#FF9800", "frequency": 433.3}, {"from": "N1REX", "to": "KC1JMH", "from_lat": 44.22916666666667, "from_lon": -69.625, "to_lat": 43.6875, "to_lon": -70.375, "color": "#FF9800", "frequency": 433.1}, {"from": "N1REX", "to": "K1NYY", "from_lat": 44.22916666666667, "from_lon": -69.625, "to_lat": 44.10416666666667, "to_lon": -69.375, "color": "#FF9800", "frequency": 433.1}, {"from": "N1REX", "to": "N1QFY", "from_lat": 44.22916666666667, "from_lon": -69.625, "to_lat": 44.22916666666667, "to_lon": -69.79166666666666, "color": "#FF9800", "frequency": 433.1}, {"from": "KC1JMH", "to": "K1NYY", "from_lat": 43.6875, "from_lon": -70.375, "to_lat": 44.10416666666667, "to_lon": -69.375, "color": "#FF9800", "frequency": 433.3}, {"from": "KC1JMH", "to": "WS1EC", "from_lat": 43.6875, "from_lon": -70.375, "to_lat": 43.72916666666667, "to_lon": -70.45833333333333, "color": "#FF9800", "frequency": 433.3}, {"from": "KC1JMH", "to": "N1REX", "from_lat": 43.6875, "from_lon": -70.375, "to_lat": 44.22916666666667, "to_lon": -69.625, "color": "#FF9800", "frequency": 433.3}, {"from": "KC1JMH", "to": "N1QFY", "from_lat": 43.6875, "from_lon": -70.375, "to_lat": 44.22916666666667, "to_lon": -69.79166666666666, "color": "#FF9800", "frequency": 433.3}, {"from": "KC1JMH", "to": "KS1R", "from_lat": 43.6875, "from_lon": -70.375, "to_lat": 43.8125, "to_lon": -69.79166666666666, "color": "#FF9800", "frequency": 433.3}, {"from": "KS1R", "to": "N1REX", "from_lat": 43.8125, "from_lon": -69.79166666666666, "to_lat": 44.22916666666667, "to_lon": -69.625, "color": "#2196F3", "frequency": 145.01}, {"from": "KS1R", "to": "KC1JMH", "from_lat": 43.8125, "from_lon": -69.79166666666666, "to_lat": 43.6875, "to_lon": -70.375, "color": "#2196F3", "frequency": 145.01}, {"from": "KS1R", "to": "N1QFY", "from_lat": 43.8125, "from_lon": -69.79166666666666, "to_lat": 44.22916666666667, "to_lon": -69.79166666666666, "color": "#2196F3", "frequency": 145.01}, {"from": "KS1R", "to": "K1NYY", "from_lat": 43.8125, "from_lon": -69.79166666666666, "to_lat": 44.10416666666667, "to_lon": -69.375, "color": "#2196F3", "frequency": 145.01}, {"from": "N1QFY", "to": "KS1R", "from_lat": 44.22916666666667, "from_lon": -69.79166666666666, "to_lat": 43.8125, "to_lon": -69.79166666666666, "color": "#FF9800", "frequency": 433.3}, {"from": "N1QFY", "to": "N1REX", "from_lat": 44.22916666666667, "from_lon": -69.79166666666666, "to_lat": 44.22916666666667, "to_lon": -69.625, "color": "#FF9800", "frequency": 433.3}, {"from": "N1QFY", "to": "KC1JMH", "from_lat": 44.22916666666667, "from_lon": -69.79166666666666, "to_lat": 43.6875, "to_lon": -70.375, "color": "#FF9800", "frequency": 433.3}, {"from": "N1QFY", "to": "K1NYY", "from_lat": 44.22916666666667, "from_lon": -69.79166666666666, "to_lat": 44.10416666666667, "to_lon": -69.375, "color": "#FF9800", "frequency": 433.3}];
        
        // Initialize map
        var map = L.map('map').setView([43.96527777777778, -69.90277777777777], 8);
        
        // Add tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors | Packet Network Map'
        }).addTo(map);
        
        // Draw connections first (so they're under markers)
        var drawnConnections = new Set();
        connections.forEach(function(conn) {
            // Deduplicate bidirectional connections
            var key = [conn.from, conn.to].sort().join('-');
            if (drawnConnections.has(key)) return;
            drawnConnections.add(key);
            
            var line = L.polyline([
                [conn.from_lat, conn.from_lon],
                [conn.to_lat, conn.to_lon]
            ], {
                color: conn.color,
                weight: 2,
                opacity: 0.7
            }).addTo(map);
            
            var freq = conn.frequency ? conn.frequency + ' MHz' : 'Unknown';
            line.bindTooltip(conn.from + ' â†” ' + conn.to + '<br>' + freq);
        });
        
        // Add node markers
        nodes.forEach(function(node) {
            var marker = L.circleMarker([node.lat, node.lon], {
                radius: 8,
                fillColor: '#e53935',
                color: '#b71c1c',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // Build popup content
            var popup = '<div class="popup-content">';
            popup += '<h3>' + node.callsign + '</h3>';
            
            if (node.city || node.state) {
                popup += '<p><span class="label">Location:</span> ' + 
                         (node.city ? node.city + ', ' : '') + (node.state || '') + '</p>';
            }
            popup += '<p><span class="label">Grid:</span> ' + node.grid + '</p>';
            popup += '<p><span class="label">Type:</span> ' + node.type + '</p>';
            
            if (node.sponsor) {
                popup += '<p><span class="label">Sponsor:</span> ' + node.sponsor + '</p>';
            }
            
            if (node.ssids && node.ssids.length > 0) {
                popup += '<p><span class="label">SSIDs:</span> ' + node.ssids.join(', ') + '</p>';
            }
            
            if (node.frequencies && node.frequencies.length > 0) {
                popup += '<p><span class="label">Frequencies:</span><br>';
                node.frequencies.forEach(function(freq) {
                    popup += '<span class="freqs" style="color:' + freq.color + ';">' + 
                             freq.text + '</span><br>';
                });
                popup += '</p>';
            }
            
            if (node.netrom_access && node.netrom_access.length > 0) {
                popup += '<p><span class="label">NetRom Access:</span><br>' + 
                         '<span class="apps">' + node.netrom_access.join(', ') + '</span></p>';
            }
            
            if (node.applications && node.applications.length > 0) {
                var apps = node.applications.slice(0, 10);  // Limit display
                popup += '<p><span class="label">Applications:</span><br>' + 
                         '<span class="apps">' + apps.join(', ') + '</span></p>';
            }
            
            popup += '<p><span class="label">Neighbors:</span> ' + node.neighbors.length + '</p>';
            popup += '</div>';
            
            marker.bindPopup(popup, { maxWidth: 300 });
            marker.bindTooltip(node.callsign, { permanent: false, direction: 'top' });
        });
        
        // Add legend
        var legend = L.control({ position: 'bottomright' });
        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<strong>Band Colors</strong><br>' +
                '<div class="legend-item"><div class="legend-color" style="background:#2196F3"></div>2m (144-148 MHz)</div>' +
                '<div class="legend-item"><div class="legend-color" style="background:#FF9800"></div>70cm (420-450 MHz)</div>' +
                '<div class="legend-item"><div class="legend-color" style="background:#9C27B0"></div>1.25m (222-225 MHz)</div>' +
                '<div class="legend-item"><div class="legend-color" style="background:#4CAF50"></div>6m (50-54 MHz)</div>' +
                '<div class="legend-item"><div class="legend-color" style="background:#888888"></div>Other/Unknown</div>';
            return div;
        };
        legend.addTo(map);
        
        // Add info box with unmapped nodes
        var unmappedNodes = ["AB1KI", "KY2D", "NG1P"];
        var info = L.control({ position: 'topright' });
        info.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'info-box');
            var unmappedHtml = '';
            if (unmappedNodes.length > 0) {
                unmappedHtml = '<hr style="margin:8px 0">' +
                    '<strong style="color:#ff9800">Unmapped Nodes</strong><br>' +
                    '<small>(no gridsquare data)</small><br>' +
                    '<span style="color:#666">' + unmappedNodes.join(', ') + '</span>';
            }
            div.innerHTML = '<strong>Packet Radio Network</strong><br>' +
                'Nodes: ' + nodes.length + '<br>' +
                'Connections: ' + connections.length + '<br>' +
                '<small>Generated by nodemap-html.py</small>' +
                unmappedHtml;
            return div;
        };
        info.addTo(map);
        
        // Fit bounds to show all nodes
        if (nodes.length > 1) {
            var bounds = L.latLngBounds(nodes.map(function(n) { return [n.lat, n.lon]; }));
            map.fitBounds(bounds, { padding: [20, 20] });
        }
    </script>
</body>
</html>